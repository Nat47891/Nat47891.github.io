{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-map"></i> เลือกล็อคที่ต้องการจอง</h3>
            </div>
            <div class="card-body">
                <h4><i class="fas fa-store"></i> {{ space[1] }}</h4>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-map-marker-alt"></i> สถานที่:</strong> {{ space[2] }}</p>
                        <p><strong><i class="fas fa-expand-arrows-alt"></i> ขนาด:</strong> {{ space[3] }}</p>
                        <p><strong><i class="fas fa-money-bill-wave"></i> ราคา:</strong> <span class="text-success">{{ space[4] }} บาท/ล็อค/วัน</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-calendar"></i> วันที่เปิด:</strong> {{ space[5] }}</p>
                        <p><strong><i class="fas fa-clock"></i> เวลาทำการ:</strong> {{ space[6] }}</p>
                        <p><strong><i class="fas fa-tools"></i> สิ่งอำนวยความสะดวก:</strong> {{ space[7] if space[7] else 'ไม่ระบุ' }}</p>
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('confirm_booking') }}" id="bookingForm">
                    <input type="hidden" name="space_id" value="{{ space[0] }}">
                    
                    <div class="mb-3">
                        <label for="booking_date" class="form-label">
                            <i class="fas fa-calendar-alt"></i> เลือกวันที่ต้องการจอง
                        </label>
                        <input type="date" class="form-control" id="booking_date" name="booking_date" 
                               value="{{ booking_date }}" required onchange="loadBookingData()">
                    </div>
                    
                    <!-- Layout Map -->
                    <div class="layout-container" id="layoutContainer">
                        <h5><i class="fas fa-th"></i> แผนผังล็อค ({{ layout_data.rows }}x{{ layout_data.cols }})</h5>
                        <div class="booking-legend mb-3">
                            <span class="legend-item">
                                <span class="slot-demo available"></span> ว่าง
                            </span>
                            <span class="legend-item">
                                <span class="slot-demo selected"></span> เลือกแล้ว
                            </span>
                            <span class="legend-item">
                                <span class="slot-demo booked"></span> จองแล้ว
                            </span>
                        </div>
                        
                        <div class="layout-grid" style="grid-template-columns: repeat({{ layout_data.cols }}, 1fr); grid-template-rows: repeat({{ layout_data.rows }}, 1fr);">
                            {% for row in range(layout_data.rows) %}
                                {% for col in range(layout_data.cols) %}
                                    {% set slot_id = (row|string|int + 65)|chr + (col + 1)|string %}
                                    {% set is_booked = slot_id in booked_slots %}
                                    <div class="slot {{ 'booked' if is_booked else 'available' }}" 
                                         data-slot="{{ slot_id }}" 
                                         data-price="{{ layout_data.slots[slot_id].price if layout_data.slots[slot_id] else space[4] }}"
                                         {% if is_booked %}
                                         data-booked-by="{{ booked_slots[slot_id] }}"
                                         title="จองโดย: {{ booked_slots[slot_id] }}"
                                         {% else %}
                                         onclick="toggleSlot(this)"
                                         title="ล็อค {{ slot_id }} - {{ layout_data.slots[slot_id].price if layout_data.slots[slot_id] else space[4] }} บาท"
                                         {% endif %}>
                                        <div class="slot-id">{{ slot_id }}</div>
                                        <div class="slot-price">{{ layout_data.slots[slot_id].price if layout_data.slots[slot_id] else space[4] }}฿</div>
                                        {% if is_booked %}
                                        <div class="slot-booked-by">{{ booked_slots[slot_id] }}</div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Selected Slots Summary -->
                    <div class="selected-summary mt-4" id="selectedSummary" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-shopping-cart"></i> ล็อคที่เลือก</h6>
                            </div>
                            <div class="card-body">
                                <div id="selectedSlotsList"></div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>ยอดรวม:</strong>
                                    <strong id="totalPrice" class="text-success">0 บาท</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="bookingBtn" disabled>
                            <i class="fas fa-credit-card"></i> จองและชำระเงิน
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> ย้อนกลับ
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> วิธีการจอง</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>เลือกวันที่ต้องการจอง</li>
                    <li>คลิกเลือกล็อคที่ต้องการ (สีเขียว = ว่าง)</li>
                    <li>ตรวจสอบล็อคที่เลือกและราคารวม</li>
                    <li>กดปุ่ม "จองและชำระเงิน"</li>
                    <li>สแกน QR Code เพื่อชำระเงิน</li>
                </ol>
                
                <div class="mt-3">
                    <h6>หมายเหตุ:</h6>
                    <ul class="small">
                        <li>สามารถเลือกได้หลายล็อค</li>
                        <li>ล็อคที่จองแล้วจะแสดงชื่อผู้จอง</li>
                        <li>ราคาอาจแตกต่างกันตามตำแหน่งล็อค</li>
                        <li>การจองมีผลหลังชำระเงินเท่านั้น</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.layout-grid {
    display: grid;
    gap: 5px;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px solid #dee2e6;
}

.slot {
    width: 80px;
    height: 80px;
    border: 2px solid #ddd;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    font-size: 0.8rem;
}

.slot.available {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: #28a745;
    color: #155724;
}

.slot.available:hover {
    background: linear-gradient(135deg, #b3d9c0 0%, #a8ddb5 100%);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.slot.selected {
    background: linear-gradient(135deg, #cce5ff 0%, #99d6ff 100%);
    border-color: #007bff;
    color: #0056b3;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.slot.booked {
    background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
    border-color: #dc3545;
    color: #721c24;
    cursor: not-allowed;
    opacity: 0.8;
}

.slot-id {
    font-weight: bold;
    font-size: 0.9rem;
}

.slot-price {
    font-size: 0.7rem;
    color: #666;
}

.slot-booked-by {
    font-size: 0.6rem;
    text-align: center;
    line-height: 1.1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 70px;
}

.booking-legend {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.slot-demo {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.slot-demo.available {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: #28a745;
}

.slot-demo.selected {
    background: linear-gradient(135deg, #cce5ff 0%, #99d6ff 100%);
    border-color: #007bff;
}

.slot-demo.booked {
    background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
    border-color: #dc3545;
}

.selected-slot-item {
    display: inline-block;
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 20px;
    padding: 5px 12px;
    margin: 2px;
    font-size: 0.9rem;
    color: #1976d2;
}

@media (max-width: 768px) {
    .slot {
        width: 60px;
        height: 60px;
        font-size: 0.7rem;
    }
    
    .slot-id {
        font-size: 0.8rem;
    }
    
    .slot-price {
        font-size: 0.6rem;
    }
    
    .layout-grid {
        gap: 3px;
        padding: 10px;
    }
}
</style>

<script>
let selectedSlots = [];

document.getElementById('booking_date').min = new Date().toISOString().split('T')[0];

function toggleSlot(slotElement) {
    const slotId = slotElement.dataset.slot;
    const slotPrice = parseFloat(slotElement.dataset.price);
    
    if (slotElement.classList.contains('selected')) {
        // ยกเลิกการเลือก
        slotElement.classList.remove('selected');
        selectedSlots = selectedSlots.filter(slot => slot.id !== slotId);
    } else {
        // เลือกล็อค
        slotElement.classList.add('selected');
        selectedSlots.push({
            id: slotId,
            price: slotPrice
        });
    }
    
    updateSelectedSummary();
}

function updateSelectedSummary() {
    const summaryDiv = document.getElementById('selectedSummary');
    const slotsList = document.getElementById('selectedSlotsList');
    const totalPriceSpan = document.getElementById('totalPrice');
    const bookingBtn = document.getElementById('bookingBtn');
    
    if (selectedSlots.length === 0) {
        summaryDiv.style.display = 'none';
        bookingBtn.disabled = true;
        return;
    }
    
    summaryDiv.style.display = 'block';
    bookingBtn.disabled = false;
    
    // แสดงรายการล็อคที่เลือก
    slotsList.innerHTML = selectedSlots.map(slot => 
        `<span class="selected-slot-item">${slot.id} (${slot.price}฿)</span>`
    ).join('');
    
    // คำนวณราคารวม
    const totalPrice = selectedSlots.reduce((sum, slot) => sum + slot.price, 0);
    totalPriceSpan.textContent = totalPrice.toLocaleString() + ' บาท';
    
    // อัปเดต hidden inputs
    updateHiddenInputs();
}

function updateHiddenInputs() {
    // ลบ hidden inputs เก่า
    const oldInputs = document.querySelectorAll('input[name="selected_slots"]');
    oldInputs.forEach(input => input.remove());
    
    // เพิ่ม hidden inputs ใหม่
    const form = document.getElementById('bookingForm');
    selectedSlots.forEach(slot => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_slots';
        input.value = slot.id;
        form.appendChild(input);
    });
}

function loadBookingData() {
    const date = document.getElementById('booking_date').value;
    const spaceId = {{ space[0] }};
    
    if (!date) return;
    
    // รีเซ็ตการเลือก
    selectedSlots = [];
    document.querySelectorAll('.slot.selected').forEach(slot => {
        slot.classList.remove('selected');
    });
    updateSelectedSummary();
    
    // โหลดข้อมูลการจองใหม่
    fetch(`/get_booking_data/${spaceId}?date=${date}`)
        .then(response => response.json())
        .then(data => {
            // อัปเดตสถานะล็อค
            document.querySelectorAll('.slot').forEach(slot => {
                const slotId = slot.dataset.slot;
                
                // รีเซ็ตสถานะ
                slot.classList.remove('booked', 'selected');
                slot.classList.add('available');
                slot.onclick = () => toggleSlot(slot);
                slot.style.cursor = 'pointer';
                
                // ลบข้อมูลผู้จองเก่า
                const bookedByDiv = slot.querySelector('.slot-booked-by');
                if (bookedByDiv) {
                    bookedByDiv.remove();
                }
                
                // ถ้าล็อคถูกจองแล้ว
                if (data.booked_slots[slotId]) {
                    slot.classList.remove('available');
                    slot.classList.add('booked');
                    slot.onclick = null;
                    slot.style.cursor = 'not-allowed';
                    slot.title = `จองโดย: ${data.booked_slots[slotId]}`;
                    
                    // เพิ่มชื่อผู้จอง
                    const bookedByDiv = document.createElement('div');
                    bookedByDiv.className = 'slot-booked-by';
                    bookedByDiv.textContent = data.booked_slots[slotId];
                    slot.appendChild(bookedByDiv);
                }
            });
        })
        .catch(error => {
            console.error('Error loading booking data:', error);
        });
}

// โหลดข้อมูลเมื่อมีวันที่เริ่มต้น
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('booking_date').value) {
        loadBookingData();
    }
});
</script>
{% endblock %}