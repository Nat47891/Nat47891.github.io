{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-cog"></i> จัดการสถานที่</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSpaceModal">
        <i class="fas fa-plus"></i> เพิ่มสถานที่ใหม่
    </button>
</div>

<!-- รายการสถานที่ -->
{% if spaces %}
<div class="row">
    {% for space in spaces %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-store"></i> {{ space[1] }}</h5>
                <p class="card-text">
                    <strong><i class="fas fa-map-marker-alt"></i> สถานที่:</strong> {{ space[2] }}<br>
                    <strong><i class="fas fa-expand-arrows-alt"></i> ขนาด:</strong> {{ space[3] }}<br>
                    <strong><i class="fas fa-money-bill-wave"></i> ราคา:</strong> {{ space[4] }} บาท/ล็อค/วัน<br>
                    <strong><i class="fas fa-calendar"></i> วันที่เปิด:</strong> {{ space[5] }}<br>
                    <strong><i class="fas fa-clock"></i> เวลา:</strong> {{ space[6] }}<br>
                    <strong><i class="fas fa-tools"></i> สิ่งอำนวยความสะดวก:</strong> {{ space[7] if space[7] else 'ไม่ระบุ' }}
                </p>
                
                <!-- แสดง Layout Preview -->
                {% if space[9] %}
                {% set layout = space[9]|from_json %}
                <div class="layout-preview mb-3">
                    <h6><i class="fas fa-th"></i> แผนผัง ({{ layout.rows }}x{{ layout.cols }})</h6>
                    <div class="mini-grid" style="grid-template-columns: repeat({{ layout.cols }}, 1fr);">
                        {% for row in range(layout.rows) %}
                            {% for col in range(layout.cols) %}
                                <div class="mini-slot"></div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="btn-group w-100">
                    <a href="{{ url_for('edit_space', space_id=space[0]) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit"></i> แก้ไข
                    </a>
                    <a href="{{ url_for('view_space_bookings', space_id=space[0]) }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-calendar-check"></i> ดูการจอง
                    </a>
                    <a href="{{ url_for('delete_space', space_id=space[0]) }}" 
                       class="btn btn-outline-danger btn-sm"
                       onclick="return confirm('ต้องการลบสถานที่นี้หรือไม่?')">
                       <i class="fas fa-trash"></i> ลบ
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center mt-5">
    <div class="empty-state">
        <div class="mb-4">
            <i class="fas fa-store-slash" style="font-size: 4rem; color: #cbd5e0;"></i>
        </div>
        <h4>ยังไม่มีสถานที่</h4>
        <p>คุณยังไม่ได้เพิ่มสถานที่สำหรับให้เช่า</p>
    </div>
</div>
{% endif %}

<!-- Modal เพิ่มสถานที่ -->
<div class="modal fade" id="addSpaceModal" tabindex="-1" aria-labelledby="addSpaceModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_space') }}" id="addSpaceForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSpaceModalLabel">
                        <i class="fas fa-plus-circle"></i> เพิ่มสถานที่ใหม่
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-store"></i> ชื่อสถานที่
                                </label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label">
                                    <i class="fas fa-map-marker-alt"></i> ที่อยู่
                                </label>
                                <input type="text" class="form-control" id="location" name="location" required>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">
                                    <i class="fas fa-money-bill-wave"></i> ราคา (บาท/ล็อค/วัน)
                                </label>
                                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                            </div>
                            <div class="mb-3">
                                <label for="amenities" class="form-label">
                                    <i class="fas fa-tools"></i> สิ่งอำนวยความสะดวก
                                </label>
                                <textarea class="form-control" id="amenities" name="amenities" rows="3" 
                                          placeholder="เช่น ไฟฟ้า, น้ำประปา, ที่จอดรถ"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-th"></i> ขนาดพื้นที่ (ล็อค)
                                </label>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="rows" class="form-label">แถว</label>
                                        <input type="number" class="form-control" id="rows" name="rows" 
                                               min="1" max="20" value="3" required onchange="updatePreview()">
                                    </div>
                                    <div class="col-6">
                                        <label for="cols" class="form-label">คอลัมน์</label>
                                        <input type="number" class="form-control" id="cols" name="cols" 
                                               min="1" max="20" value="3" required onchange="updatePreview()">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="available_days" class="form-label">
                                    <i class="fas fa-calendar"></i> วันที่เปิด
                                </label>
                                <input type="text" class="form-control" id="available_days" name="available_days" 
                                       placeholder="เช่น จันทร์,พุธ,ศุกร์" required>
                            </div>
                            <div class="mb-3">
                                <label for="available_time" class="form-label">
                                    <i class="fas fa-clock"></i> เวลาทำการ
                                </label>
                                <input type="text" class="form-control" id="available_time" name="available_time" 
                                       placeholder="เช่น 08:00-18:00" required>
                            </div>
                            
                            <!-- Preview Layout -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-eye"></i> ตัวอย่างแผนผัง
                                </label>
                                <div id="layoutPreview" class="layout-preview-container">
                                    <div class="preview-grid" id="previewGrid">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">
                        <i class="fas fa-times"></i> ยกเลิก
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i> เพิ่มสถานที่
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.layout-preview {
    text-align: center;
}

.mini-grid {
    display: grid;
    gap: 2px;
    max-width: 100px;
    margin: 0 auto;
}

.mini-slot {
    width: 15px;
    height: 15px;
    background: #28a745;
    border: 1px solid #155724;
    border-radius: 2px;
}

.layout-preview-container {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    background: #f8f9fa;
    text-align: center;
}

.preview-grid {
    display: grid;
    gap: 3px;
    max-width: 200px;
    margin: 0 auto;
}

.preview-slot {
    width: 25px;
    height: 25px;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 1px solid #28a745;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: #155724;
    font-weight: bold;
}

@media (max-width: 768px) {
    .preview-slot {
        width: 20px;
        height: 20px;
        font-size: 0.6rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ลบ backdrop ที่อาจจะค้างอยู่
    function removeAllBackdrops() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.body.style.removeProperty('overflow');
    }

    removeAllBackdrops();

    const modal = document.getElementById('addSpaceModal');
    const form = document.getElementById('addSpaceForm');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // แสดง preview เริ่มต้น
    updatePreview();

    modal.addEventListener('hidden.bs.modal', function() {
        removeAllBackdrops();
        form.reset();
        updatePreview();
    });

    cancelBtn.addEventListener('click', function() {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
        removeAllBackdrops();
    });

    form.addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';
    });

    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            e.stopPropagation();
        }
    });
});

function updatePreview() {
    const rows = parseInt(document.getElementById('rows').value) || 3;
    const cols = parseInt(document.getElementById('cols').value) || 3;
    const previewGrid = document.getElementById('previewGrid');
    
    // อัปเดต grid style
    previewGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    previewGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    
    // ล้างและสร้าง slots ใหม่
    previewGrid.innerHTML = '';
    
    for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
            const slot = document.createElement('div');
            slot.className = 'preview-slot';
            slot.textContent = String.fromCharCode(65 + row) + (col + 1);
            previewGrid.appendChild(slot);
        }
    }
}

// ฟังก์ชันฉุกเฉินสำหรับลบ backdrop
function forceRemoveBackdrop() {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('padding-right');
    document.body.style.removeProperty('overflow');
    console.log('Force removed all backdrops');
}

setInterval(function() {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    if (backdrops.length > 0 && !document.querySelector('.modal.show')) {
        forceRemoveBackdrop();
    }
}, 1000);
</script>
{% endblock %}